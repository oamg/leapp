<head>
    <title>Le-App</title>
    <meta charset="utf-8">
    <link href="../base1/patternfly.css" type="text/css" rel="stylesheet">
    <script src="../base1/jquery.js"></script>
    <script src="../base1/cockpit.js"></script>
    <style>
        #panel-body {
            width: 100%;
            height: auto;
            float: left;
            margin: 10px 0 10px 0;
            border: 1px solid #ddd;
        }

        #panel-body #tables-head, #panel-body #machines-list, #panel-body #credentials,
        #panel-body #ports {
            width: 100%;
            float: left;
            display: flex;
        }

        #panel-body h2, #panel-body h3 {
            float: left;
            text-align: center;
            display: block;
            width: 100%;
        }

        #panel-body ul {
            margin: 10px;
            clear: both;
        }

        #panel-body li {
            display: block;
            list-style-type: none;
        }

        #panel-body li label, #panel-body li span {
            margin-left: 30px;
            font-size: 16px;
        }

        #panel-body .wd50-left {
            width: 50%;
            float: left;
        }

        #panel-body #ports ul li {
            font-size: 15px;
            margin-left: 50px;
        }

        #panel-body .border-top-dashed {
            border-top: 2px dashed #ddd;
        }

        #panel-body .border-left-dashed {
            border-left: 2px dashed #ddd;
        }

        #migrate-button {
            margin: 5px 15px 15px 0;
        }

        #panel-body input[name=target-ports] {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="panel panel-default">
            <div class="panel-heading">
                <span translatable="yes">Local Virtual Machines</span>
                <div class="pull-right">
                    <button translatable="yes" class="btn btn-default btn-primary" id="list-vms">Refresh</button>
                </div>
            </div>
        </div>
        <div style="height:30px;">
            <div class="spinner spinner-lg" id="loader"></div>
        </div>
        <div id="panel-body">
            <div id="tables-head">
                <div class="wd50-left">
                    <h2>Source</h2>
                </div>
                <div class="wd50-left border-left-dashed">
                    <h2>Target</h2>
                </div>
            </div>
            <div id="machines-list" class="border-top-dashed">
                <div id="source-machines" class="wd50-left">
                    <ul></ul>
                </div>
                <div id="target-machines" class="wd50-left border-left-dashed">
                    <ul></ul>
                </div>
            </div>
            <div id="credentials" style="min-height: 75px; display: none;" class="border-top-dashed">
                <div id="source-credentials" class="wd50-left">
                    <h3>Credentials to source host</h3>
                </div>
                <div id="target-credentials" class="wd50-left border-left-dashed">
                    <h3>Credentials to target host</h3>
                </div>
            </div>
            <div id="ports" class="border-top-dashed" style="display: none;">
                <div id="source-ports" class="wd50-left">
                    <h3>Source host discovered ports</h3>
                    <ul></ul>
                </div>
                <div id="target-ports" class="wd50-left border-left-dashed">
                    <h3>Target host mapped ports</h3>
                    <ul></ul>
                </div>
            </div>
        </div>
        <button translatable="yes" class="btn btn-default btn-primary migrate-app pull-right ui-lockable"
        id="migrate-button" disabled>Migrate</button>
        <p>
            <pre id="output" style="clear: both"></pre>
        </p>
    </div>

    <script>
        const DOCKER_RANDOM_PORT = "RANDOM";

        var output = $("#output");
        var loader = $("#loader");

        // flag to show "wait for result" message after command exc - must be removed after summit !
        var wait_for_result_msg = false;

        $("#list-vms").on("click", list_local_vms);
        $(".migrate-app").on("click", migrate_to_host);

        // Automatically load the VM list when the page opens
        $(document).ready(function() {
            list_local_vms();
        });

        function set_lock_cmd() {
            $(".ui-lockable").attr("disabled", true);
        }

        function release_lock_cmd() {
            $(".ui-lockable").removeAttr("disabled");
        }

        function call_leapp(cmd_args) {
            set_lock_cmd();
            return cockpit.spawn(
                ["/usr/bin/leapp-tool"].concat(cmd_args),
                {
                    "superuser": "required",
                    "directory": "/usr/bin/",
                    "err": "out"
                }
            );
        }

        function list_local_vms() {
            var proc = call_leapp(["list-machines", "--shallow"]);
            proc.done(refresh_vm_table);
            proc.fail(list_local_vms_fail);

            output.empty();
            out("Refreshing VM list");
            loader.show();
        }

        function refresh_vm_table(data) {
            var vm_data = JSON.parse(data);
            $("#credentials, #ports").fadeOut();
            $("#machines-list ul li, #ports ul li").remove()
            $("#migrate-button").attr("disabled", true);
            for (var idx in vm_data.machines) {
                var machine = vm_data.machines[idx];

                // ugly way to expose ports for jBPMS - must be removed after summit !
                ports = "9000:9000";
                if (machine.hostname == "centos6-drools") {
                    ports = "8080:8080";
                }

                var machine_html = `
                    <li>
                        <input id="machine-radio-${machine.ip[0]}" class="radio-[type]-machine ui-lockable" 
                        type="radio" name="[type]-machine" value="${machine.hostname}" data-ip="${machine.ip[0]}"
                        data-ports="${ports}" />
                        <label for="machine-radio-${machine.ip[0]}">${machine.hostname}</label>
                    </li>
                `;

                if (machine.name.indexOf("target") > -1) {
                    $("#target-machines ul").append(machine_html.replace(/\[type\]/g, "target"))
                } else {
                    $("#source-machines ul").append(machine_html.replace(/\[type\]/g, "source"))
                }
            }
            output.empty();
            if (vm_data.machines.length == 0) {
                output.append(document.createTextNode("No running local VMs!\n"));
            }
            loader.hide();

            $(".radio-source-machine").click(function(event) {
                var ip_addr = $(event.target).data('ip');
                var ports = '22,80,8080,9000';
                scan_ports(ports, ip_addr, show_source_ports);
            });

            $(".radio-target-machine").on('click', check_target_ports);
        }

        function list_local_vms_fail(data) {
            output.empty();
            output.append(document.createTextNode("Command failed!\n"));
            output.append(document.createTextNode(data));
            loader.hide();
        }

        function out(line) {
            output.append(`<div style="padding: 2px">${line}</div>`)
        }

        function migrate_to_host(event) {
            wait_for_result_msg = true;

            var source = $("input[name=source-machine]:checked").val();
            var target = $("input[name=target-machine]:checked").val();

            var mapped_ports = $("#panel-body input.source-ports:checked").map(function() {
                var target_port = $("#panel-body input[name=" + this.value + "]").val();
                if (target_port) {
                    if (target_port === DOCKER_RANDOM_PORT)
                        return this.value;
                    else
                        return target_port + ':' + this.value;  // host:container
                }
            }).toArray();

            var proc = call_leapp([
                    "migrate-machine",
                    "--tcp-port"
                ].concat(mapped_ports, [
                    // TODO: Rely on ssh-agent, rather than a hardcoded known SSH key
                    "--identity", "/opt/leapp/integration-tests/config/leappto_testing_key",
                    "-t", target, source
                ])
            );

            output.empty();
            proc.done(cmd_success);
            proc.fail(cmd_fail);
            proc.stream(cmd_stdout);

            out(`Migrating ${source} to ${target}`);
            loader.show();
        }

        function scan_ports(ports, ip_addr, callback) {

            var proc = call_leapp([
                "port-inspect", ports, ip_addr
            ]);

            output.empty();
            proc.done(callback);
            proc.fail(cmd_fail);

            out(`Scanning ports on ${ip_addr}`);
            loader.show();
        }

        function show_source_ports(data) {
            $("#ports ul li").remove();
            var ports_data = JSON.parse(data);
            // get all protocols not only tcp
            if (typeof(ports_data.ports.tcp) !== undefined) {
                for (port in ports_data.ports.tcp) {
                    $("#source-ports ul").append(`
                        <li>
                            <input type="checkbox" name="source-ports" value="${port}" 
                            checked="checked" disabled style="display: none" class="source-ports" />
                            Port: <strong>${port}</strong> - used by: ${ports_data.ports.tcp[port].product}
                        </li>
                    `)
                }
            }

            $("#credentials").fadeIn(); // this shouldn't be here, now it's only to show full page
            $("#ports").fadeIn();

            output.empty();
            loader.hide();
            
            release_lock_cmd();
            check_target_ports();
        }

        function map_ports(ports_range, busy_ports, selected_ports) {

            var used_ports = {};
            var mapped_ports = {};

            for (i in ports_range) {
                used_ports[ports_range[i]] = [];
            }

            function get_available_port(min_port, max_port, excluded_ports) {
                if (max_port - min_port - excluded_ports.length == 0)
                    // if DOKCER_RANDOM_PORT is returned then docker should automatically assign port
                    return DOCKER_RANDOM_PORT;
                for (var port = min_port; port <= max_port; port++) {
                    port = port.toString();
                    if (excluded_ports.indexOf(port) > -1)
                        continue;
                    return port;
                }
            }

            for (i in selected_ports) {
                source_port = selected_ports[i];
                for (range in used_ports) {
                    let interval = range.split('-');
                    let min_port = parseInt(interval[0]);
                    let max_port = parseInt(interval[1]);

                    if (! (min_port <= source_port && source_port <= max_port)) {
                        continue;
                    }

                    used_ports[range].push(source_port);
                    if (source_port in busy_ports) {
                        target_port = get_available_port(min_port, max_port, used_ports[range]);
                    } else {
                        target_port = source_port;
                    }
                    mapped_ports[source_port] = target_port;
                }
            }

            return mapped_ports;
        }

        var ports_scan_range = [];
        function check_target_ports() {
            if (! $("input[name=target-machine]:checked").length ||
                ! $("input[name=source-machine]:checked").length) {
                return;
            }

            var ip_addr = $("input[name=target-machine]:checked").data('ip');

            var selected_ports_cnt = $("#panel-body input.source-ports:checked").length;
            var min_port = null;
            var max_port = null;
            var ports_interval = 25;

            function add_ports_range(min_port, max_port) {
                ports_scan_range.push(min_port.toString() + '-' + max_port.toString());
            }

            $("#panel-body input.source-ports:checked").map(function(index) {
                selected_ports_cnt--;

                if (min_port === null) {
                    min_port = parseInt(this.value);
                    max_port = min_port;
                }

                if (parseInt(this.value) <= max_port) {
                    max_port += ports_interval;

                    if (selected_ports_cnt <= 0) {
                        add_ports_range(min_port, max_port);
                    }

                } else {
                    // get element from last loop
                    add_ports_range(min_port, max_port);

                    min_port = parseInt(this.value);
                    max_port = min_port + ports_interval;

                    if (selected_ports_cnt <= 0) {
                        add_ports_range(min_port, max_port);
                    }
                }

            });

            if (ports_scan_range) {
                scan_ports(ports_scan_range.join(','), ip_addr, show_target_ports);
            } else {
                console.log("couldn not find selected ports");
            }
        }

        function show_target_ports(data) {
            data = JSON.parse(data);

            loader.show();
            output.append(document.createTextNode("Mapping target ports"));

            var selected_ports = $("#panel-body input.source-ports:checked").map(function() {
                return this.value;
            }).toArray();

            if (typeof(data.ports.tcp) !== undefined && data.ports.tcp) {
                var busy_ports = data.ports.tcp  
            } else {
                var busy_ports = {};
            };

            var mapped_ports = map_ports(ports_scan_range, busy_ports, selected_ports);

            $("#target-ports ul li").remove();
            for (source_port in mapped_ports) {
                $("#target-ports ul").append(`
                    <li>
                        Port:
                        <input type="text" size="6" name="${source_port}" value="${mapped_ports[source_port]}"
                        class="target-ports" disabled />
                        &rarr; ${source_port}
                    </li>
                `)

            }

            loader.hide();
            output.empty();
            release_lock_cmd();
        }

        function cmd_stdout(data) {
            let split = data.split(/\r?\n/);
            for (let line of split) {
                if (line.length < 1 || line[0] != "!") {
                    continue;
                }
                out("> " + line.substring(2));
            }
        }

        function cmd_success(data) {
            //output.empty();
            cmd_stdout(data);
            output.append(document.createTextNode("Command completed successfully"));
            if (wait_for_result_msg) {
                output.append(document.createTextNode("\n\nMigrated service is now starting, please wait about 2 minutes to see results.."));
            }
            loader.hide();

            release_lock_cmd();
            wait_for_result_msg = false;
        }

        function cmd_fail(exc, data) {
            //output.empty();
            cmd_stdout(data);
            err_msg = `Command failed with status ${exc.exit_status}!\n`
            output.append(document.createTextNode(err_msg));
            loader.hide();
            release_lock_cmd();
        }

    </script>
</body>
</html>

